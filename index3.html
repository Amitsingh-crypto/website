<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
<!-- 
Proof of concept de consumo de dados da geolocalização dos ônibus do RJ em tempo real. Os dados são atualizados a cada minuto.
Dados retirados de http://data.rio.rj.gov.br/dataset/gps-de-onibus , contudo algumas linhas ainda não tem a geolocalização disponibilizada.
A resposta vem meio cagada quando usei callback JSONP tradicional, então acabei sendo obrigado a usar um proxy localmente com PHP.

Pode copiar, reutilizar e melhorar este código à vontade.

Autor: Marco Jardim
-->
  <head>
  <style>
  #qsrxSearchbar
{
    width: 240px;
    height: 30px;
    overflow: hidden;
    background-color: yellow;
	position:fixed;
	margin-left: 100px;
}

#qsrxSearchbar input
{
    width: 100%
}

#qsrxSearchbar label
{
    float: left
}

#qsrxSearchbar span 
{
    display: block;
    overflow: hidden;
    padding: 0 5px
}

#qsrxSearchbar button 
{
    float: right
}

#qsrxSearchbar input, .formLine button
{ 
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box
}
  
  </style>
      <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	      <title>Ônibus - Rio de Janeiro</title>
		      <script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=false"></script>
			  <script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
			      <script type="text/javascript">

				         
     
				  
var map;
var markers = [];

function addMarker(location) {
  var marker = new google.maps.Marker({
    position: location,
    map: map
  });
  markers.push(marker);
}

function setAllMap(map) {
  for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(map);
  }
}

function clearMarkers() {
  setAllMap(null);
}

function showMarkers() {
  setAllMap(map);
}

function deleteMarkers() {
  clearMarkers();
  markers = [];
}
function initialize() {
	var mapDiv = document.getElementById('map-canvas');
	map = new google.maps.Map(mapDiv, {
	center: new google.maps.LatLng(-22.9083, -43.1964),
	zoom: 12,
	mapTypeId: google.maps.MapTypeId.ROADMAP
});
}

google.maps.Map.prototype.clearMarkers = function() {
    for(var i=0; i < this.markers.length; i++){
        this.markers[i].setMap(null);
    }
    this.markers = new Array();
};


$(document).on("click","#btnSearch", function(event){
        event.preventDefault();  
        var q = $("#theq").val();
        $.getJSON("/proxy.php",
        {
          linha: q
        },
        function(data) {
			setAllMap(null);
			for (var i = 0; i < data.DATA.length; i++) {
				var latLng = new google.maps.LatLng(data.DATA[i][3],
				data.DATA[i][4]);
				addMarker(latLng);
			}
          
        });
    });


google.maps.event.addDomListener(window, 'load', initialize);
	      </script>
		</head>
	  <body style="font-family: Arial; border: 0 none;">
  <div id="map-canvas" style="position:absolute; width: 100%; height: 100%;">
	
  </div>
 	<div id="emulating_variable_width">
	   <form id="srxForm" method="post">
			 <div id="qsrxSearchbar"> 
				 <button id="btnSearch">Buscar</button>             
				 <label id="scope"> Linha do ônibus: </label>
				 <span><input type="text" id="theq" title="Search" /></span>
			  </div>
		</form> 
	</div>
 
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49628280-1', 'citbus.com');
  ga('send', 'pageview');

</script>
</body>
</html>

